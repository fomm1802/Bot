import discord
from discord.ext import commands
import re
import logging

logging.basicConfig(level=logging.INFO, format="%(levelname)s: %(message)s")

class LinkDetection(commands.Cog):
    """Cog ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°"""

    def __init__(self, bot: commands.Bot):
        self.bot = bot
        self.link_pattern = re.compile(r"https?://[^\s]+")  # Regex ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå

    @commands.Cog.listener()
    async def on_message(self, message: discord.Message):
        """‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏≤‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô Embed"""
        if message.author.bot or not message.guild:
            return  # ‡∏Ç‡πâ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ö‡∏≠‡∏ó‡πÅ‡∏•‡∏∞ DM

        urls = self.link_pattern.findall(message.content)
        if not urls:
            return  # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ

        # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ö‡∏≠‡∏ó‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if not message.channel.permissions_for(message.guild.me).send_messages:
            logging.warning(f"‚ö†Ô∏è ‡∏ö‡∏≠‡∏ó‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô {message.channel.name}")
            return

        # ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ
        logging.info(f"üîç ‡∏û‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏à‡∏≤‡∏Å {message.author.name}: {urls}")

        embed = discord.Embed(
            title="üîç ‡∏û‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå",
            description=f"‡∏™‡πà‡∏á‡πÇ‡∏î‡∏¢ {message.author.mention}",
            color=discord.Color.blue()
        )
        embed.set_thumbnail(url=message.author.display_avatar.url)
        embed.add_field(name="üë§ ‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á", value=f"‡∏ä‡∏∑‡πà‡∏≠: {message.author.display_name} (ID: {message.author.id})", inline=False)
        embed.add_field(name="‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤", value=f"<t:{int(message.created_at.timestamp())}:F>", inline=False)

        for i, url in enumerate(urls, 1):
            embed.add_field(name=f"üåê ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏µ‡πà {i}:", value=url, inline=False)

        try:
            await message.channel.send(embed=embed)
            logging.info("‚úÖ ‡∏™‡πà‡∏á Embed ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")
        except discord.Forbidden:
            logging.error(f"‚ùå ‡∏ö‡∏≠‡∏ó‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô {message.channel.name}")
        except discord.HTTPException as e:
            logging.error(f"‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: {e}")
        except Exception as e:
            logging.error(f"‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Ñ‡∏≤‡∏î‡∏Ñ‡∏¥‡∏î: {e}")

async def setup(bot: commands.Bot):
    """‡πÄ‡∏û‡∏¥‡πà‡∏° Cog ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏ö‡∏≠‡∏ó"""
    logging.info("üìå ‡πÇ‡∏´‡∏•‡∏î Cog: LinkDetection")
    await bot.add_cog(LinkDetection(bot))
